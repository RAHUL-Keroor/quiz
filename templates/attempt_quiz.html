{% extends "base.html" %}
{% block title %}Attempt Quiz{% endblock %}
{% block content %}

<div class="container mt-4">

  {# ------------------------------------------------------------- #}
  {# WAITING ROOM BEFORE QUIZ START #}
  {# ------------------------------------------------------------- #}
  {% if wait_seconds is defined %}
  <div class="text-center mt-5">
    <h2>‚è≥ Quiz "{{ quiz.Quiz_name or quiz.quiz_code }}" will start soon!</h2>

    <div class="mt-3">
      <h5>üïí Current Time: <span id="currentTime"></span></h5>
      <h5 class="text-success">
        üìÖ Quiz Start Time (IST): {{ display_start.strftime('%I:%M %p') }}
      </h5>
    </div>

    <div id="countdown" class="display-4 text-danger mt-4 fw-bold"></div>
    <p class="text-muted mt-3">Please wait... The quiz will start automatically.</p>
  </div>

  <script>
    // Live clock
    function updateCurrentTime() {
      const now = new Date();
      document.getElementById("currentTime").textContent =
        now.toLocaleTimeString("en-IN", { hour12: true });
    }
    updateCurrentTime();
    setInterval(updateCurrentTime, 1000);

    // Countdown
    let waitLeft = {{ wait_seconds }};
    const cd = document.getElementById("countdown");

    function updateCountdown() {
      const m = Math.floor(waitLeft / 60);
      const s = waitLeft % 60;
      cd.textContent = `${m}:${s.toString().padStart(2, "0")}`;

      if (waitLeft <= 0) {
        clearInterval(t);
        window.location.reload();
      }
      waitLeft--;
    }
    updateCountdown();
    const t = setInterval(updateCountdown, 1000);
  </script>

  {% elif not final_view %}
  {# ------------------------------------------------------------- #}
  {# QUIZ ATTEMPT SCREEN #}
  {# ------------------------------------------------------------- #}

  <div class="d-flex justify-content-between mb-3">
    <h3>üß† Attempt Quiz ‚Äî {{ quiz.quiz_code }}</h3>

    <div class="bg-dark text-white px-3 py-2 rounded">
      ‚è± Time Left: <span id="quizTimer"></span>
    </div>
  </div>

  {% if msg %}
  <div class="alert alert-warning text-center">{{ msg }}</div>
  {% endif %}

  <form id="quizForm" method="POST">
    {% for q in questions %}
    <div class="card mb-3 shadow-sm">
      <div class="card-body">
        <h5>Q{{ loop.index }}. {{ q.question_text }}</h5>

        {% for opt in q.options %}
        <div class="form-check">
          <input class="form-check-input" type="radio" name="q_{{ q._id }}" id="q_{{ q._id }}_{{ loop.index }}"
            value="{{ opt }}">
          <label class="form-check-label" for="q_{{ q._id }}_{{ loop.index }}">{{ opt }}</label>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endfor %}

    <div class="text-center mt-3">
      <button type="submit" class="btn btn-primary px-5">Submit Quiz</button>
    </div>
  </form>

  <script>
    // Timer logic
    let totalSeconds = ({{ quiz.timer_minutes or 5 }} * 60);
    const timerLabel = document.getElementById("quizTimer");
    const quizForm = document.getElementById("quizForm");

    function updateTimer() {
      const m = Math.floor(totalSeconds / 60);
      const s = totalSeconds % 60;
      timerLabel.textContent = `${m}:${s.toString().padStart(2, "0")}`;

      if (totalSeconds <= 0) {
        clearInterval(t);
        alert("‚è∞ Time's up ‚Äî submitting your answers.");
        quizForm.submit();
      }
      totalSeconds--;
    }
    updateTimer();
    const t = setInterval(updateTimer, 1000);
  </script>

  {% else %}
  {# ------------------------------------------------------------- #}
  {# RESULTS SCREEN #}
  {# ------------------------------------------------------------- #}

  <div class="alert alert-info text-center shadow-sm">
    <h4>‚úî Your Score: {{ score }} / {{ total_questions }}</h4>
  </div>

  {% for q in questions %}
  {% set qid = q._id|string %}
  {% set user_ans = submitted.get(qid) %}

  <div class="card mb-3 shadow-sm">
    <div class="card-body">
      <h5>Q{{ loop.index }}. {{ q.question_text }}</h5>
      <p><strong>Your Answer:</strong> {{ user_ans or "Not answered" }}</p>
      <p><strong>Correct Answer:</strong> {{ q.correct_answer }}</p>

      {% if q.description %}
      <p class="text-muted"><strong>Explanation:</strong> {{ q.description }}</p>
      {% endif %}

      {% if user_ans == q.correct_answer %}
      <span class="badge bg-success">Correct</span>
      {% else %}
      <span class="badge bg-danger">Incorrect</span>
      {% endif %}
    </div>
  </div>

  {% endfor %}
  {% endif %}

</div>

{% endblock %}